name: Validate Links (Nightly)

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-links:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check links with lychee
      uses: lycheeverse/lychee-action@v1
      with:
        args: --verbose --no-progress '[0-9]*/**/*.md'
        fail: false  # Don't fail the workflow, just report
        
    - name: Upload link check report
      uses: actions/upload-artifact@v3
      with:
        name: link-validation-report
        path: ./lychee/out.md
        retention-days: 7
        
    - name: Create issue if links are broken
      if: env.lychee_exit_code != 0
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          let report = '';
          try {
            report = fs.readFileSync('./lychee/out.md', 'utf8');
          } catch (e) {
            report = 'Report file not found';
          }
          
          const body = `## ‚ö†Ô∏è Broken Links Detected
          
          The nightly link validation check found broken links:
          
          ${report}
          
          **Action Items:**
          - Check if resources have moved (look for redirects)
          - Update links to new locations  
          - Remove resources that are permanently unavailable
          - Consider adding archived versions from Wayback Machine
          
          ---
          ü§ñ *This issue was automatically created by the link validation workflow*`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `[Link Validation] Broken links detected on ${new Date().toISOString().split('T')[0]}`,
            body: body,
            labels: ['automated', 'broken-links', 'maintenance']
          });
