name: Validate Links (Nightly)

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-links:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install -r scripts/requirements.txt
        
    - name: Find filled files
      id: find-files
      run: |
        # Find all non-template markdown files
        find [0-9]* -name "*.md" -type f | while read file; do
          if ! grep -q "Add resources below" "$file" 2>/dev/null; then
            echo "$file"
          fi
        done > filled_files.txt
        echo "Found $(wc -l < filled_files.txt) filled files"
        
    - name: Validate links
      id: validate
      continue-on-error: true
      run: |
        mkdir -p link-reports
        FAILED_FILES=""
        
        # Check each file
        while read file; do
          echo "Checking $file..."
          if ! python3 scripts/validate_links.py "$file" --timeout 15 > "link-reports/${file//\//_}.txt" 2>&1; then
            FAILED_FILES="$FAILED_FILES $file"
          fi
        done < filled_files.txt
        
        # Create summary
        if [ -n "$FAILED_FILES" ]; then
          echo "FAILED_FILES=$FAILED_FILES" >> $GITHUB_OUTPUT
          echo "status=failed" >> $GITHUB_OUTPUT
        else
          echo "status=passed" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload link reports
      uses: actions/upload-artifact@v3
      with:
        name: link-validation-reports
        path: link-reports/
        retention-days: 7
        
    - name: Create issue if links are broken
      if: steps.validate.outputs.status == 'failed'
      uses: actions/github-script@v6
      with:
        script: |
          const failed = '${{ steps.validate.outputs.FAILED_FILES }}';
          const files = failed.trim().split(' ');
          
          const body = `## âš ï¸ Broken Links Detected
          
          The nightly link validation check found broken links in the following files:
          
          ${files.map(f => `- \`${f}\``).join('\n')}
          
          Please review the link validation reports in the workflow artifacts.
          
          **Action Items:**
          - Check if resources have moved (look for redirects)
          - Update links to new locations
          - Remove resources that are permanently unavailable
          - Consider adding archived versions from Wayback Machine
          
          ---
          ðŸ¤– *This issue was automatically created by the link validation workflow*`;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `[Link Validation] Broken links detected on ${new Date().toISOString().split('T')[0]}`,
            body: body,
            labels: ['automated', 'broken-links', 'maintenance']
          });
